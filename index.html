<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Tool</title>
    
    <meta name="theme-color" content="#f8f9fa">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-1024.png">
    <link rel="apple-touch-icon" href="icon-1024.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --font-family: 'Cairo', sans-serif;
            --tabs-bg-color: #f1f3f5;
        }

        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 2rem; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .app-container { width: 100%; max-width: 600px; background: var(--surface-color); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08); overflow: hidden; }
        .tabs { display: flex; background-color: var(--tabs-bg-color); border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .tab-button { flex: 1; padding: 1rem; border: none; background: transparent; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; font-family: var(--font-family); border-radius: 12px 12px 0 0; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { padding: 2rem; }
        .hidden { display: none; }
        h2 { margin-top: 0; font-size: 1.5rem; text-align: center; margin-bottom: 1.5rem; }
        
        textarea { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-sizing: border-box; 
            margin-bottom: 1rem; 
            font-size: 1rem; 
            font-family: var(--font-family); 
            transition: border-color 0.2s ease-in-out; 
            resize: none; 
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }
        
        textarea::-webkit-scrollbar { display: none; }
        textarea:focus { outline: none; border-color: var(--primary-color); }
        .btn { display: block; width: 100%; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; text-align: center; transition: background-color 0.3s ease; font-family: var(--font-family); text-decoration: none; box-sizing: border-box; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        #drop-zone { border: 2px dashed var(--border-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        #drop-zone.dragover { border-color: var(--primary-color); background-color: #e9f5ff; }
        #reader-result { margin-top: 1.5rem; padding: 1rem; background-color: #e9ecef; border-radius: 8px; text-align: right; word-wrap: break-word; font-weight: 600; line-height: 1.6; white-space: pre-wrap; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--surface-color); padding: 2rem; border-radius: 12px; position: relative; width: 90%; max-width: 280px; text-align: center; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 10px; left: 15px; font-size: 2rem; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        
        #modal-qrcode-display { margin: 1.5rem 0; display: flex; justify-content: center; }
        #modal-qrcode-display img { max-width: 100%; border-radius: 8px; }
        
        #modal-download-link { margin: 1rem auto 0; }
    </style>
    <!-- مكتبة التوليد (بقيت كما هي) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- (مهم) استبدال مكتبة القراءة بمكتبة html5-qrcode القوية -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>

    <div class="app-container">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('generator')">إنشاء رمز</button>
            <button class="tab-button" onclick="showTab('reader')">قراءة رمز</button>
        </div>

        <div id="generator-content" class="tab-content">
            <h2>إنشاء رمز QR جديد</h2>
            <textarea id="text-input" rows="7" placeholder="أدخل النص أو الرابط هنا..."></textarea>
            <button id="generate-btn" class="btn btn-primary">إنشاء الرمز</button>
        </div>

        <div id="reader-content" class="tab-content hidden">
            <h2>قراءة رمز QR من صورة</h2>
            <input type="file" id="qr-file-input" accept="image/*" class="hidden">
            <div id="drop-zone">
                <p>اسحب وأفلت الصورة هنا، أو انقر للاختيار</p>
            </div>
            <div id="reader-result" class="hidden"></div>
            <!-- عنصر وهمي لتهيئة المكتبة الجديدة -->
            <div id="reader-placeholder" style="display: none;"></div>
        </div>
    </div>

    <div id="qr-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>رمز QR الخاص بك</h3>
            <div id="modal-qrcode-display"></div>
            <a id="modal-download-link" class="btn btn-primary" download="qrcode.png">تنزيل الرمز</a>
        </div>
    </div>

    <script>
        const generatorTab = document.getElementById('generator-content');
        const readerTab = document.getElementById('reader-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const textInput = document.getElementById('text-input');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('qr-file-input');
        const readerResult = document.getElementById('reader-result');
        const generateBtn = document.getElementById('generate-btn');
        const qrModal = document.getElementById('qr-modal');
        const modalQrDisplay = document.getElementById('modal-qrcode-display');
        const modalDownloadLink = document.getElementById('modal-download-link');
        const closeButton = document.querySelector('.close-button');

        function showTab(tabName) {
            const isGenerator = tabName === 'generator';
            generatorTab.classList.toggle('hidden', !isGenerator);
            readerTab.classList.toggle('hidden', isGenerator);
            tabButtons[0].classList.toggle('active', isGenerator);
            tabButtons[1].classList.toggle('active', !isGenerator);
        }

        function drawRoundedRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }

        function drawFinder(ctx, x, y, tileSize, color) {
            const size7 = tileSize * 7;
            const size5 = tileSize * 5;
            const size3 = tileSize * 3;
            
            ctx.fillStyle = color;
            drawRoundedRect(ctx, x, y, size7, size7, tileSize * 1.5); 

            ctx.fillStyle = '#ffffff';
            const offsetWhite = (size7 - size5) / 2;
            drawRoundedRect(ctx, x + offsetWhite, y + offsetWhite, size5, size5, tileSize * 1.0);

            ctx.fillStyle = color;
            const offsetInner = (size7 - size3) / 2;
            drawRoundedRect(ctx, x + offsetInner, y + offsetInner, size3, size3, tileSize * 0.8);
        }

        async function generateQRCode() {
            const text = textInput.value.trim();
            if (!text) { alert('الرجاء إدخال نص أو رابط.'); return; }
            generateBtn.textContent = '... جاري الإنشاء ...';
            generateBtn.disabled = true;

            try {
                const rawQR = QRCode.create(text, { errorCorrectionLevel: 'H' });
                const moduleCount = rawQR.modules.size;
                const tileSize = 20; 
                const margin = tileSize * 4; 
                const canvasSize = (moduleCount * tileSize) + (margin * 2);

                const canvas = document.createElement('canvas');
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvasSize, canvasSize);

                const qrColor = '#000000';

                ctx.fillStyle = qrColor;
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        const isFinder = (
                            (row < 7 && col < 7) || 
                            (row < 7 && col >= moduleCount - 7) || 
                            (row >= moduleCount - 7 && col < 7)
                        );

                        if (isFinder) continue;

                        if (rawQR.modules.get(row, col)) {
                            const x = margin + (col * tileSize);
                            const y = margin + (row * tileSize);
                            
                            ctx.beginPath();
                            const centerX = x + (tileSize / 2);
                            const centerY = y + (tileSize / 2);
                            const radius = (tileSize / 2) * 0.85;
                            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }

                drawFinder(ctx, margin, margin, tileSize, qrColor);
                drawFinder(ctx, margin + ((moduleCount - 7) * tileSize), margin, tileSize, qrColor);
                drawFinder(ctx, margin, margin + ((moduleCount - 7) * tileSize), tileSize, qrColor);

                const dataUrl = canvas.toDataURL('image/png');
                modalQrDisplay.innerHTML = `<img src="${dataUrl}" alt="QR Code" style="width: 100%; height: auto;">`;
                modalDownloadLink.href = dataUrl;
                qrModal.classList.add('visible');

            } catch (err) {
                console.error(err);
                alert('عذراً، لم نتمكن من إنشاء رمز QR. قد يكون النص طويلاً جداً.');
            } finally {
                generateBtn.textContent = 'إنشاء الرمز';
                generateBtn.disabled = false;
            }
        }

        // --- دالة القراءة المعدلة (تستخدم Html5Qrcode) ---
        async function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) { alert('الرجاء اختيار ملف صورة صالح.'); return; }
            
            readerResult.classList.remove('hidden');
            readerResult.textContent = 'جاري تحليل الرمز...';
            
            try {
                // نستخدم div مخفي لتهيئة المكتبة
                const html5QrCode = new Html5Qrcode("reader-placeholder");
                const result = await html5QrCode.scanFile(file, true);
                
                if (result) {
                    setResult(result);
                } else {
                    setResult(null);
                }
            } catch (err) {
                // هذه المكتبة ترمي خطأ إذا لم تجد رمزاً، وهذا طبيعي
                console.log(err);
                setResult(null);
            }
        }

        function setResult(data) {
            if (data) { readerResult.textContent = data; } 
            else { readerResult.textContent = 'عذراً، لم يتم العثور على رمز QR في الصورة (تأكد من وضوح الصورة).'; }
        }

        generateBtn.addEventListener('click', generateQRCode);
        closeButton.addEventListener('click', () => qrModal.classList.remove('visible'));
        qrModal.addEventListener('click', (e) => { if (e.target === qrModal) qrModal.classList.remove('visible'); });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragleave'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) { handleFile(e.dataTransfer.files[0]); fileInput.value = ''; } });
    </script>
    
    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }
    </script>
    
</body>
</html>